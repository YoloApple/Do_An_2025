_format_version: "3.0"

#================================
# SERVICES & ROUTES
#================================
services:
  #----------------------------
  # Auth Service on Railway
  #----------------------------
  - name: auth-service
    url: https://doan2025-production.up.railway.app
    tags: [ "auth" ]
    routes:
      # PUBLIC routes (Không JWT)
      - name: auth-public-routes
        paths:
          - /api/v1/auth/login
          - /api/v1/auth/signup
          - /api/v1/auth/refresh
          - /api/v1/auth/forgot-password
          - /api/v1/auth/reset-password
          - /api/v1/auth/logout
        strip_path: false
        methods:
          - GET
          - POST
          - OPTIONS
          - PATCH
        tags: [ "auth", "public" ]

      # PROTECTED route (Có JWT)
      - name: me-route
        paths:
          - /api/v1/me
        strip_path: false
        methods:
          - GET
          - PATCH
          - PUT
          - OPTIONS
        tags: [ "auth", "protected" ]

  #----------------------------
  # Course Service
  #----------------------------
  - name: course-service
    url: https://bedoan2025-production.up.railway.app
    tags: [ "courses" ]
    routes:
      - name: course-routes
        paths:
          - /api/courses
          - /api/courses/
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        tags: [ "courses", "protected" ]

  #----------------------------
  # Lesson Service
  #----------------------------
  - name: lesson-service
    url: https://bedoan2025-production.up.railway.app
    tags: [ "lessons" ]
    routes:
      - name: lesson-routes
        paths:
          - /api/lessons
          - /api/lessons/
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        tags: [ "lessons", "protected" ]

  #----------------------------
  # AI Service
  #----------------------------
  - name: ai-service
    url: https://virtual-classroom-ai-agent-production.up.railway.app
    tags: [ "ai" ]
    routes:
      - name: ai-routes
        paths:
          - /api/v1/ai
          - /api/agent/chat
          - /api/lessons/mindmap
          - /api/agent/analyzer
          - /api/session
          - /api/user/level
          - /api/health
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        tags: [ "ai", "protected" ]

#================================
# JWT CONSUMERS & SECRETS
#================================
consumers:
  - username: auth-service-consumer
    jwt_secrets:
      - key: "auth-service"
        secret: "your-super-secret-jwt-key-min-32-characters-long-for-hs256"
        algorithm: HS256

#================================
# PLUGINS
#================================
plugins:
  #--------------------------------------
  # JWT CHO ROUTE /api/v1/me
  #--------------------------------------
  - name: jwt
    route: me-route
    tags: [ "jwt-plugin", "auth", "protected" ]
    config:
      key_claim_name: "iss"
      claims_to_verify: [ "exp" ]
      run_on_preflight: false

  #--------------------------------------
  # JWT CHO course-service
  #--------------------------------------
  - name: jwt
    service: course-service
    tags: [ "jwt-plugin", "courses", "protected" ]
    config:
      key_claim_name: "iss"
      claims_to_verify: [ "exp" ]
      run_on_preflight: false

  #--------------------------------------
  # JWT CHO lesson-service
  #--------------------------------------
  - name: jwt
    service: lesson-service
    tags: [ "jwt-plugin", "lessons", "protected" ]
    config:
      key_claim_name: "iss"
      claims_to_verify: [ "exp" ]
      run_on_preflight: false

  #--------------------------------------
  # JWT CHO ai-service
  #--------------------------------------
  - name: jwt
    service: ai-service
    tags: [ "jwt-plugin", "ai", "protected" ]
    config:
      key_claim_name: "iss"
      claims_to_verify: [ "exp" ]
      run_on_preflight: false

  #--------------------------------------
  # CORS CHO TOÀN BỘ DỰ ÁN
  #--------------------------------------
  - name: cors
    tags: [ "cors-plugin" ]
    config:
      origins:
        - "https://ai-agent-virtual-classroom-fe.vercel.app"
        - "http://localhost:3000"
      methods: [ "GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS" ]
      headers: [ "Authorization", "Content-Type" ]
      credentials: true
      max_age: 3600
      preflight_continue: false
